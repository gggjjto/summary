# CAN总线协议

## 1.CAN简介

CAN是控制器域网 (Controller Area Network, CAN) 的简称。CAN属于总线式串行通信网络。

![在这里插入图片描述](https://img-blog.csdnimg.cn/7e385c01c9044bb6a59415ca94da8925.png#pic_center)

1. CAN节点通过CAN_High、CAN_Low两根线接入CAN总线网络。
2. CAN收发器将CAN控制器的CAN_TX输出的逻辑值0、1转换为差分信号
3. 通过CAN_High、CAN_Low向总线输出；同时将总线上的差分信号转换为逻辑值0、1。
4. 通过CAN_RX传输给CAN控制器。
   

CAN_High、CAN_Low的差分电压与逻辑值0、1的关系：![在这里插入图片描述](https://img-blog.csdnimg.cn/f8f6397906fc4c4dbcdb3052577ddc3b.png#pic_center)

![在这里插入图片描述](https://img-blog.csdnimg.cn/fdc8bf6f6582439a9cda887baff6cb67.jpeg#pic_center)

## 2.CAN数据报文帧结构

CAN数据报文分**标准和扩展**两种类型。

标准数据报文结构：帧起始(SOF)、仲裁段、控制段、数据段、CRC段、ACK段、帧结束(EOF)

- **帧起始**占1位，值为0，表示一帧数据报文的开始，帧结束占7位，值都为1，表示一帧数据报文的结束。
- **仲裁段**包括11位的标识符ID和1位RTR
  - 每个节点发送的数据报文使用独立的标识符ID，接收方可以通过标识符ID判断数据报文来自哪个节点；
  - RTR指示该数据报文是数据帧还是遥控帧，RTR值为0时表示数据帧，值为1时表示遥控帧，遥控帧不含数据段，节点可以通过发送遥控帧来请求其它节点发送数据。
  - 当多个节点同时发送数据报文时，节点通过仲裁段来参与总线的竞争，竞争获胜的一方可继续发送数据报文。
- **控制段**包括1位IDE、1位r0、4位的DLC。
  - IDE指示该数据报文属于**标准数据报文还是扩展数据报文**，IDE值为**0时表示标准数据报文**，值为**1时表示扩展数据报文**。DLC指示数据段的字节数（最大值应为8），r0值为0。
- 实际要传输的数据放在**数据段**，占0 ~ 8个字节，即一帧数据报文最多只能携带8个字节的数据内容。数据段的字节数通过DLC指定。
- **CRC段**包含**15位的CRC和1位CRC界定符**。
  - CRC的**计算范围包括帧起始、仲裁段、控制端、数据段**，接收节点在接收数据报文时**也会计算CRC**，与数据报文中的CRC进行比较，**如果不一致会报CRC错误。CRC界定符的值为1**。
- ACK段包括1位ACK槽和1位ACK界定符。
  - **发送节点在ACK槽输出1**，接收节点**如果正确接收到数据报文，会在ACK槽输出0作为应答**。ACK界定符的值为1。

## 3.总线仲裁

- 当多个节点同时发送数据报文时，节点通过仲裁段来参与总线的竞争。
- **节点向总线发送数据的同时会检测总线的电平状态。**

## 4.位填充

- 节点发送数据报文时，在数据报文的SOF至CRC段内，如果出现连续5个位的0，要在下一个位插入1， 如果出现连续5个位的1，则要在下一个位插入0 。
- 节点接收数据报文时，要去掉填充位，即在数据报文的SOF～CRC 段内，如果发现连续5个位的0或连续5个位的1，要删除下一个位，即去掉填充位。

## 5.CAN错误帧，过载帧结构以及帧间隔

- 在数据报文传输过程中，节点检测出总线错误后会发送错误帧。
- 错误帧由错误标志和错误界定符构成。
- 错误标志分主动错误标志（连续6个位的0）和被动错误标志（连续6个位的1）。
- 处于主动错误状态的节点检测出错误时会发送带主动错误标志的错误帧，处于被动错误状态的节点在检测出错误时会发送带被动错误标志的错误帧。
- 错误界定符是连续8个位的1。节点发送完错误标志后，从检测到总线的第一个1开始的连续8个位的1作为错误帧的界定符。
- 发送数据报文的节点检测出错误
  - 该节点停止数据报文的发送，转为发送错误帧。错误帧的错误标志会破坏原数据报文的结构，其它节点可能在错误标志的任何一位检测出错误，然后在下一位开始发送错误帧，因此错误标志会出现重叠部分。
- 接收数据报文的节点检测出错误
  - 如果该节点处于主动错误状态，会发送带主动错误标志的错误帧。**主动错误标志会破坏总线上正在传输的数据报文的结构，其它节点可能在主动错误标志的任何一位检测出错误，然后在下一位开始发送错误帧，因此错误标志会出现重叠部分。**
  -  如果该节点处于被动错误状态，会发送带被动错误标志的错误帧。**被动错误标志对总线上正在传输的数据报文没有影响。**
- 帧间隔用于将数据帧或遥控帧与前面的帧（可以是数据帧、遥控帧、错误帧、过载帧）分离开来，帧间隔是连续3个位的1。处于被动错误状态的节点，在输出帧间隔时需要在帧间隔之后插入“延迟传送”（连续8个位的1）。

## 6.CAN总线错误类型

位错误、ACK错误、填充错误、CRC错误、格式错误。

1. 位错误
   - 节点发送数据报文，输出0时检测到总线为1，或输出1时检测到总线为0，该节点检测出一个位错误。但以下两种情况除外：
     - 在数据报文的仲裁段，节点输出1时检测到总线为0，说明该节点竞争总线失败，不视为位错误；
     - 在数据报文的ACK槽，发送节点输出1时检测到总线为0，说明有接收节点正确接收到数据报文并输出0来做出应答，不视为位错误。
2. ACK错误：
   - 节点发送数据报文时，在ACK槽检测到总线为1（即没有接收节点正确接收到数据报文并输出0来做出应答），该节点检测出一个位错误。